<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Counter View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --muted: rgba(0,0,0,0.55); --good:#16a34a; --warn:#f59e0b; --bad:#ef4444; }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{
      background-image: url("background.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#000;
    }

    .wrap{
      width:100%;
      max-width:980px;
      margin:24px;
      padding:24px;
      background: rgba(255,255,255,0.0);
      border-radius:18px;
      text-align:center;
      position:relative;
    }

    /* status badge top-right */
    .status-badge{
      position: fixed;
      top: 24px;
      right: 24px;
      display:flex;
      gap:16px;
      align-items:center;
      background: rgba(255,255,255,0.95);
      color:#000;
      padding:16px 20px;
      border-radius:16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      font-weight:700;
      font-size:18px;
      z-index:12000;
    }
    
    /* WiFi bars container */
    .wifi-bars{
      display:flex;
      align-items:flex-end;
      gap:4px;
      height:32px;
      width:40px;
    }
    .wifi-bar{
      flex:1;
      background: var(--muted);
      border-radius:2px;
      transition: background 0.3s ease, opacity 0.3s ease;
      opacity: 0.25;
    }
    .wifi-bar.active{
      opacity: 1;
    }
    .wifi-bar:nth-child(1){ height: 25%; }
    .wifi-bar:nth-child(2){ height: 50%; }
    .wifi-bar:nth-child(3){ height: 75%; }
    .wifi-bar:nth-child(4){ height: 100%; }
    
    .status-text { font-size:18px; color: #000; font-weight:700; }

    /* big centered number */
    .count-box{
      display:flex;
      align-items:center;
      justify-content:center;
      width:100%;
      height:400px;
      margin:10px auto;
      user-select:none;
      background: rgba(255,255,255,0.92);
      border-radius:20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.12);
    }
    .count{
      font-size:180px;
      font-weight:900;
      color:#000;
      line-height:0.95;
    }

    .info { color:white; margin-top:16px; font-size:18px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

    /* large goal bottom center */
    .goal-bottom{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 24px;
      background: rgba(255,255,255,0.92);
      padding:16px 28px;
      border-radius:999px;
      box-shadow:0 8px 30px rgba(0,0,0,0.12);
      font-weight:900;
      font-size:28px;
      color:#000;
      z-index:11000;
    }

    .offline-bar { position:fixed; left:0; right:0; bottom:0; background:#b91c1c; color:white; padding:14px 18px; text-align:center; font-weight:700; font-size:16px; display:none; z-index:9999; }

    /* confetti */
    .confetti{ position: fixed; pointer-events:none; left:0; top:0; right:0; bottom:0; overflow:visible; z-index:9998; }
    .confetti-piece{ position:absolute; width:10px; height:14px; opacity:0.95; transform-origin:center; will-change: transform, top, left; border-radius:2px; }
    
    /* high five animation */
    .highfive-container{ position: fixed; pointer-events:none; left:0; top:0; right:0; bottom:0; overflow:hidden; z-index:9997; }
    .highfive{
      position:absolute;
      font-size: 48px;
      will-change: transform, top, left, opacity;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    /* pulse animation for count increase */
    .pulse{
      animation: pulseAnim 300ms ease-out;
    }
    @keyframes pulseAnim {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="status-badge" id="statusBadge" aria-live="polite">
    <div class="wifi-bars" id="wifiBars" title="connection strength">
      <div class="wifi-bar"></div>
      <div class="wifi-bar"></div>
      <div class="wifi-bar"></div>
      <div class="wifi-bar"></div>
    </div>
    <div>
      <div class="status-text" id="statusText">Connectingâ€¦</div>
      <div style="font-size:15px;color:rgba(0,0,0,0.6);font-weight:600" id="latText">-- ms</div>
    </div>
  </div>

  <div class="wrap" role="main">
    <div class="count-box">
      <div class="count" id="countDisplay">0</div>
    </div>

    <div class="info">View Only Mode - Count updates in real-time</div>
  </div>

  <div class="goal-bottom" id="goalBottom" style="display:none">Goal: â€”</div>
  <div class="offline-bar" id="offlineBar">YOU ARE OFFLINE! Waiting to reconnect...</div>
  <div class="confetti" id="confettiLayer" aria-hidden="true"></div>
  <div class="highfive-container" id="highfiveContainer" aria-hidden="true"></div>

<script>
/* ---------- Firebase config ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCPU33ZcxWoS9NUaDEYJvNcB8FvVtdBTrg",
  authDomain: "notey-4455f.firebaseapp.com",
  databaseURL: "https://notey-4455f-default-rtdb.firebaseio.com",
  projectId: "notey-4455f",
  storageBucket: "notey-4455f.firebasestorage.app",
  messagingSenderId: "554664934050",
  appId: "1:554664934050:web:2e0a56b2dd0823cafa35fb",
  measurementId: "G-L0RJKWNMN7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------- Realtime DB refs ---------- */
const countRef = db.ref('/count');
const goalRef = db.ref('/goal');
const connectedRef = db.ref('.info/connected');

/* ---------- UI elements ---------- */
const countDisplay = document.getElementById('countDisplay');
const offlineBar = document.getElementById('offlineBar');
const wifiBars = document.getElementById('wifiBars');
const statusText = document.getElementById('statusText');
const latText = document.getElementById('latText');
const goalBottom = document.getElementById('goalBottom');
const confettiLayer = document.getElementById('confettiLayer');
const highfiveContainer = document.getElementById('highfiveContainer');

/* ---------- Sound Effects ---------- */
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

function playPopSound() {
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
  oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
  
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.1);
}

function playSubtractSound() {
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
  oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.15);
  
  gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.15);
}

function playGoalSound() {
  // Victory fanfare with multiple notes
  const notes = [
    { freq: 523.25, time: 0, duration: 0.15 },      // C5
    { freq: 659.25, time: 0.15, duration: 0.15 },   // E5
    { freq: 783.99, time: 0.3, duration: 0.15 },    // G5
    { freq: 1046.50, time: 0.45, duration: 0.4 }    // C6 (held)
  ];
  
  notes.forEach(note => {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.setValueAtTime(note.freq, audioContext.currentTime + note.time);
    
    gainNode.gain.setValueAtTime(0, audioContext.currentTime + note.time);
    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + note.time + 0.02);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + note.time + note.duration);
    
    oscillator.start(audioContext.currentTime + note.time);
    oscillator.stop(audioContext.currentTime + note.time + note.duration);
  });
}

/* ---------- Local state ---------- */
let serverCount = 0;
let previousCount = 0; // Track previous count for animations
let isConnected = false;
let currentGoal = null;
let confettiInterval = null;
let goalSoundPlayed = false; // Track if we've played the goal sound

/* ---------- Latency tracking ---------- */
let samples = [];
const MAX_SAMPLES = 5;
let currentBars = 2;
let retrying = false;
const TEST_URL = "https://noteyai.github.io/highfive";

/* ---------- Render UI ---------- */
function render(){
  // Check if count increased to trigger effects
  if (serverCount > previousCount) {
    playPopSound();
    triggerHighFives(3);
    countDisplay.classList.add('pulse');
    setTimeout(() => countDisplay.classList.remove('pulse'), 300);
  } else if (serverCount < previousCount) {
    playSubtractSound();
  }
  
  previousCount = serverCount;
  countDisplay.textContent = serverCount;
  offlineBar.style.display = isConnected ? 'none' : 'block';

  if (currentGoal === null) {
    goalBottom.style.display = 'none';
    goalSoundPlayed = false; // Reset when no goal
  } else {
    goalBottom.textContent = `Goal: ${currentGoal}`;
    goalBottom.style.display = 'block';
  }

  // confetti logic and goal sound: if total >= goal -> confetti + sound
  if (currentGoal !== null && serverCount >= currentGoal) {
    if (!goalSoundPlayed) {
      playGoalSound();
      goalSoundPlayed = true;
    }
    startConfetti();
  } else {
    stopConfetti();
    if (currentGoal !== null && serverCount < currentGoal) {
      goalSoundPlayed = false; // Reset if we go below goal
    }
  }
}

/* ---------- Confetti ---------- */
const confettiColors = ['#ef4444','#f97316','#f59e0b','#10b981','#06b6d4','#3b82f6','#8b5cf6','#ec4899','#fde68a','#bbf7d0'];
function spawnConfettiPiece(){
  const el = document.createElement('div');
  el.className = 'confetti-piece';
  const w = 6 + Math.random()*20;
  const h = w * (0.8 + Math.random()*0.8);
  el.style.width = w + 'px';
  el.style.height = h + 'px';
  el.style.left = (Math.random()*100) + 'vw';
  el.style.top = '-12vh';
  el.style.background = confettiColors[Math.floor(Math.random()*confettiColors.length)];
  el.style.transform = `rotate(${Math.random()*360}deg)`;
  const dur = 1500 + Math.random()*2200;
  const drift = (Math.random()*200) - 100;
  el.animate([
    { transform: `translate(0px, 0vh) rotate(${Math.random()*360}deg)`, opacity:1 },
    { transform: `translate(${drift}px, ${110 + Math.random()*60}vh) rotate(${Math.random()*720}deg)`, opacity:0.15 }
  ], { duration: dur, easing: 'cubic-bezier(.2,.6,.2,1)' });
  confettiLayer.appendChild(el);
  setTimeout(()=> el.remove(), dur + 120);
}
function startConfetti(){
  if (confettiInterval) return;
  for (let i=0;i<140;i++) spawnConfettiPiece();
  confettiInterval = setInterval(()=> {
    const burst = 18 + Math.floor(Math.random()*30);
    for (let i=0;i<burst;i++) spawnConfettiPiece();
  }, 220);
}
function stopConfetti(){
  if (!confettiInterval) return;
  clearInterval(confettiInterval);
  confettiInterval = null;
}

/* ---------- High Five Animation ---------- */
function spawnHighFive() {
  const highfive = document.createElement('div');
  highfive.className = 'highfive';
  highfive.textContent = 'ðŸ™Œ';
  
  highfive.style.left = (Math.random() * 100) + 'vw';
  highfive.style.bottom = '-60px';
  
  const duration = 2000 + Math.random() * 1500;
  const drift = (Math.random() * 150) - 75;
  const rotation = (Math.random() * 90) - 45; // Random rotation
  const scale = 0.8 + Math.random() * 0.4; // Random size variation
  
  highfive.animate([
    { 
      transform: `translateX(0px) translateY(0px) rotate(0deg) scale(${scale})`, 
      opacity: 0 
    },
    { 
      transform: `translateX(${drift/2}px) translateY(-40vh) rotate(${rotation/2}deg) scale(${scale})`, 
      opacity: 1,
      offset: 0.2
    },
    { 
      transform: `translateX(${drift}px) translateY(-110vh) rotate(${rotation}deg) scale(${scale * 0.7})`, 
      opacity: 0 
    }
  ], { 
    duration: duration, 
    easing: 'ease-out' 
  });
  
  highfiveContainer.appendChild(highfive);
  setTimeout(() => highfive.remove(), duration);
}

function triggerHighFives(count = 5) {
  for (let i = 0; i < count; i++) {
    setTimeout(() => spawnHighFive(), i * 50);
  }
}

/* ---------- Connection tracking ---------- */
connectedRef.on('value', snap => {
  isConnected = !!snap.val();
  updateStatusIndicator();
  render();
});

/* ---------- Listen for remote changes ---------- */
countRef.on('value', snap => {
  const v = snap.val();
  serverCount = (typeof v === 'number') ? v : (v ? Number(v) : 0);
  render();
});

/* ---------- Goal listener ---------- */
goalRef.on('value', snap => {
  const v = snap.val();
  currentGoal = (v === null || v === undefined) ? null : Number(v);
  render();
});

/* ---------- Connection Monitoring with Ping ---------- */
function latencyToBars(ms) {
  if (ms < 100) return 4;
  if (ms < 200) return 3;
  if (ms < 300) return 2;
  return 1;
}

async function pingUntilLoaded() {
  const url = TEST_URL + "?ping=" + Date.now();
  const start = performance.now();
  try {
    await fetch(url, { cache: "no-store", mode: "no-cors" });
    const latency = performance.now() - start;
    
    retrying = false;
    samples.push(latency);
    if (samples.length > MAX_SAMPLES) samples.shift();
    
    const avg = samples.reduce((a, b) => a + b, 0) / samples.length;
    const targetBars = latencyToBars(avg);
    
    if (targetBars > currentBars) currentBars++;
    else if (targetBars < currentBars) currentBars--;
    
    updateStatusIndicator(avg);
  } catch {
    retrying = true;
    currentBars = 0;
    samples = [];
    updateStatusIndicator(null);
    requestAnimationFrame(pingUntilLoaded);
  }
}

function startConnectionMonitor() {
  if (!retrying) pingUntilLoaded();
}

/* ---------- Status indicator ---------- */
function updateStatusIndicator(latencyMs){
  const bars = wifiBars.querySelectorAll('.wifi-bar');
  
  if (!isConnected) {
    bars.forEach(bar => {
      bar.classList.remove('active');
      bar.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bad');
    });
    statusText.textContent = 'Disconnected';
    latText.textContent = '-- ms';
    return;
  }
  
  if (latencyMs === null || latencyMs === undefined) {
    statusText.textContent = 'Measuring...';
    latText.textContent = '-- ms';
    bars.forEach((bar, index) => {
      if (index < currentBars) {
        bar.classList.add('active');
        bar.style.background = '#999';
      } else {
        bar.classList.remove('active');
        bar.style.background = getComputedStyle(document.documentElement).getPropertyValue('--muted');
      }
    });
    return;
  }
  
  const roundedLatency = Math.round(latencyMs * 10) / 10;
  latText.textContent = `${roundedLatency} ms`;
  
  let barColor = '';
  
  if (latencyMs < 100) {
    barColor = getComputedStyle(document.documentElement).getPropertyValue('--good');
    statusText.textContent = 'Excellent';
  } else if (latencyMs < 200) {
    barColor = getComputedStyle(document.documentElement).getPropertyValue('--good');
    statusText.textContent = 'Good';
  } else if (latencyMs < 300) {
    barColor = getComputedStyle(document.documentElement).getPropertyValue('--warn');
    statusText.textContent = 'Fair';
  } else {
    barColor = getComputedStyle(document.documentElement).getPropertyValue('--bad');
    statusText.textContent = 'Slow';
  }
  
  bars.forEach((bar, index) => {
    if (index < currentBars) {
      bar.classList.add('active');
      bar.style.background = barColor;
    } else {
      bar.classList.remove('active');
      bar.style.background = getComputedStyle(document.documentElement).getPropertyValue('--muted');
    }
  });
}

/* ---------- Initial setup ---------- */
updateStatusIndicator(null);
startConnectionMonitor();
setInterval(startConnectionMonitor, 5000);
render();

window.addEventListener('beforeunload', () => {
  retrying = false;
});
</script>
</body>
</html>

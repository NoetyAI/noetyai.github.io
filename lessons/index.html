<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Notey ‚Äî Lessons</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap"
            rel="stylesheet" />
        <!-- PDF.js for PDF text extraction -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
        <style>
            /* CSS Variables */
            :root {
                --font-main: "DM Sans", system-ui, sans-serif;
                --font-mono: "Space Mono", monospace;

                --primary: #6366f1;
                --primary-hover: #4f46e5;
                --primary-light: #eef2ff;
                --accent: #22d3ee;
                --accent-dark: #0891b2;

                --bg: #fafbfc;
                --card-bg: #ffffff;
                --text: #1e293b;
                --text-muted: #64748b;
                --border: #e2e8f0;

                --danger: #ef4444;
                --danger-bg: #fee2e2;

                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
                --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                --shadow-lg: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
                --shadow-xl: 0 20px 40px -5px rgba(0, 0, 0, 0.15);

                --radius: 12px;
                --radius-lg: 16px;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family: var(--font-main);
                background: var(--bg);
                color: var(--text);
                line-height: 1.6;
                min-height: 100vh;
            }

            header {
                background: linear-gradient(135deg, var(--primary) 0%, var(--accent-dark) 100%);
                color: #fff;
                padding: 1.25rem 2rem;
                box-shadow: var(--shadow-lg);
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .header-content {
                max-width: 1200px;
                margin: 0 auto;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 1rem;
            }

            .logo {
                font-size: 1.5rem;
                font-weight: 700;
                font-family: var(--font-mono);
                display: flex;
                align-items: center;
                gap: 0.5rem;
                cursor: pointer;
                text-decoration: none;
                color: #fff;
            }

            .logo::before {
                content: "üìö";
                font-size: 1.75rem;
            }

            .container {
                max-width: 1200px;
                margin: 2rem auto;
                padding: 0 1.5rem;
            }

            .card {
                background: var(--card-bg);
                border-radius: var(--radius-lg);
                padding: 2rem;
                box-shadow: var(--shadow);
                border: 1px solid var(--border);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            h2 {
                font-size: 2rem;
                font-weight: 700;
                margin-bottom: 1rem;
                color: var(--text);
            }

            h3 {
                font-size: 1.5rem;
                font-weight: 600;
                margin-bottom: 1rem;
                color: var(--text);
            }

            h4 {
                font-size: 1.25rem;
                font-weight: 600;
                margin-bottom: 0.75rem;
                color: var(--text);
            }

            button,
            .btn {
                font-family: var(--font-main);
                font-weight: 500;
                padding: 0.75rem 1.5rem;
                border: none;
                border-radius: var(--radius);
                cursor: pointer;
                transition: all 0.2s ease;
                font-size: 1rem;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                text-decoration: none;
                box-shadow: var(--shadow-sm);
            }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .btn-primary {
                background: linear-gradient(135deg, var(--primary), var(--accent-dark));
                color: #fff;
            }

            .btn-primary:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .btn-secondary {
                background: var(--card-bg);
                color: var(--primary);
                border: 2px solid var(--primary);
            }

            .btn-secondary:hover:not(:disabled) {
                background: var(--primary-light);
            }

            .btn-danger {
                background: var(--danger-bg);
                color: var(--danger);
                border: 1px solid var(--danger);
            }

            .btn-danger:hover:not(:disabled) {
                background: var(--danger);
                color: #fff;
            }

            .btn-ai {
                background: linear-gradient(135deg, #8b5cf6, #ec4899);
                color: #fff;
            }

            .btn-ai:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px -3px rgba(139, 92, 246, 0.4);
            }

            .btn-transcribe {
                background: linear-gradient(135deg, #0891b2, #06b6d4);
                color: #fff;
            }

            .btn-transcribe:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px -3px rgba(8, 145, 178, 0.4);
            }

            .btn-sm {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            input,
            select,
            textarea {
                font-family: var(--font-main);
                padding: 0.875rem 1rem;
                border: 2px solid var(--border);
                border-radius: var(--radius);
                font-size: 1rem;
                width: 100%;
                transition: all 0.2s ease;
                background: var(--card-bg);
            }

            input:focus,
            select:focus,
            textarea:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px var(--primary-light);
            }

            textarea {
                resize: vertical;
                min-height: 120px;
                font-family: var(--font-main);
                line-height: 1.6;
            }

            .form-group {
                margin-bottom: 1.5rem;
            }

            .form-group label {
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 500;
                color: var(--text);
            }

            .form-row {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .row {
                display: flex;
                gap: 1rem;
                align-items: center;
                flex-wrap: wrap;
            }

            .space-between {
                justify-content: space-between;
            }

            .hidden {
                display: none !important;
            }

            .grid-2 {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 1.5rem;
            }

            .item-card {
                background: var(--card-bg);
                border: 2px solid var(--border);
                border-radius: var(--radius);
                padding: 1.5rem;
                transition: all 0.2s ease;
                cursor: pointer;
            }

            .item-card:hover {
                border-color: var(--primary);
                box-shadow: var(--shadow-lg);
                transform: translateY(-2px);
            }

            .item-card-title {
                font-size: 1.25rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
                color: var(--text);
            }

            .item-card-meta {
                color: var(--text-muted);
                font-size: 0.9rem;
                margin-bottom: 1rem;
            }

            .item-card-actions {
                display: flex;
                gap: 0.75rem;
                flex-wrap: wrap;
            }

            .ai-section {
                background: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%);
                border: 2px solid #d8b4fe;
                border-radius: var(--radius-lg);
                padding: 2rem;
                margin-top: 2rem;
            }

            .ai-section h4 {
                color: #7c3aed;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .ai-section h4::before {
                content: "‚ú®";
                font-size: 1.5rem;
            }

            .ai-output {
                background: white;
                border-radius: var(--radius);
                padding: 1.5rem;
                margin-top: 1rem;
                border: 1px solid #e9d5ff;
                line-height: 1.7;
                white-space: pre-wrap;
                max-height: 400px;
                overflow-y: auto;
            }

            .ai-loading {
                text-align: center;
                padding: 2rem;
                color: var(--text-muted);
            }

            .ai-loading::after {
                content: "...";
                animation: dots 1.5s steps(4, end) infinite;
            }

            @keyframes dots {
                0%,
                20% {
                    content: ".";
                }
                40% {
                    content: "..";
                }
                60%,
                100% {
                    content: "...";
                }
            }

            .muted {
                color: var(--text-muted);
                font-size: 0.95rem;
            }

            .mb-2 {
                margin-bottom: 1rem;
            }
            .mb-3 {
                margin-bottom: 1.5rem;
            }

            .empty-state {
                text-align: center;
                padding: 3rem 1rem;
                color: var(--text-muted);
            }

            .empty-state-icon {
                font-size: 4rem;
                margin-bottom: 1rem;
                opacity: 0.5;
            }

            .breadcrumb {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-bottom: 1.5rem;
                color: var(--text-muted);
                font-size: 0.9rem;
            }

            .breadcrumb a {
                color: var(--text-muted);
                text-decoration: none;
                cursor: pointer;
            }

            .breadcrumb a:hover {
                color: var(--primary);
            }

            .breadcrumb-separator {
                color: var(--border);
            }

            .breadcrumb-current {
                color: var(--text);
                font-weight: 500;
            }

            /* Formatting toolbar styles */
            .formatting-toolbar {
                background: var(--bg);
                border: 2px solid var(--border);
                border-radius: var(--radius);
                padding: 0.75rem;
                margin-bottom: 0.5rem;
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
                align-items: center;
            }

            .toolbar-btn {
                padding: 0.5rem 0.75rem;
                border: 1px solid var(--border);
                background: white;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.2s;
                min-width: 36px;
                text-align: center;
            }

            .toolbar-btn:hover {
                background: var(--primary-light);
                border-color: var(--primary);
            }

            .toolbar-btn.active {
                background: var(--primary);
                color: white;
                border-color: var(--primary);
            }

            .toolbar-separator {
                width: 1px;
                height: 24px;
                background: var(--border);
                margin: 0 0.25rem;
            }

            /* Color picker button */
            .color-picker-wrapper {
                position: relative;
                display: inline-block;
            }

            .color-picker-btn {
                width: 32px;
                height: 32px;
                border-radius: 6px;
                border: 1px solid var(--border);
                cursor: pointer;
                position: relative;
                overflow: hidden;
            }

            .color-picker-btn input[type="color"] {
                position: absolute;
                top: -10px;
                left: -10px;
                width: 60px;
                height: 60px;
                border: none;
                cursor: pointer;
            }

            /* Search bar styles */
            .search-container {
                position: relative;
                margin-bottom: 1rem;
            }

            .search-input {
                padding-left: 2.5rem;
            }

            .search-icon {
                position: absolute;
                left: 1rem;
                top: 50%;
                transform: translateY(-50%);
                color: var(--text-muted);
                pointer-events: none;
            }

            .search-results {
                background: var(--card-bg);
                border: 2px solid var(--primary);
                border-radius: var(--radius);
                padding: 1rem;
                margin-top: 0.5rem;
                max-height: 200px;
                overflow-y: auto;
            }

            .search-result-item {
                padding: 0.5rem;
                margin-bottom: 0.5rem;
                background: var(--bg);
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .search-result-item:hover {
                background: var(--primary-light);
            }

            .search-highlight {
                background: #fef08a;
                padding: 0.1rem 0.2rem;
                border-radius: 3px;
            }

            .search-count {
                color: var(--text-muted);
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }

            /* Enhanced note content area with live preview */
            .note-editor-container {
                position: relative;
                border: 2px solid var(--border);
                border-radius: var(--radius);
                overflow: hidden;
                background: white;
            }

            .note-editor-container:focus-within {
                border-color: var(--primary);
                box-shadow: 0 0 0 3px var(--primary-light);
            }

            #note-content, #ppt-content {
                font-family: var(--font-mono);
                line-height: 1.8;
                min-height: 400px;
                border: none;
                background: transparent;
                position: relative;
                z-index: 2;
                color: transparent;
                caret-color: var(--text);
                padding: 1rem;
                -webkit-text-fill-color: transparent;
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
            }

            #note-content::selection, #ppt-content::selection {
                background: transparent;
                color: transparent;
                -webkit-text-fill-color: transparent;
            }

            #note-content::-moz-selection, #ppt-content::-moz-selection {
                background: transparent;
                color: transparent;
            }

            #note-content:focus, #ppt-content:focus {
                outline: none;
                border: none;
                box-shadow: none;
            }

            #note-preview, #ppt-preview {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                padding: 1rem;
                font-family: var(--font-mono);
                line-height: 1.8;
                pointer-events: all;
                z-index: 1;
                white-space: pre-wrap;
                word-wrap: break-word;
                overflow-y: auto;
                user-select: text;
                -webkit-user-select: text;
                -moz-user-select: text;
                -ms-user-select: text;
                cursor: text;
            }
            
            .copy-notes-btn {
                margin-left: 0.5rem;
            }

            /* Live preview formatting styles */
            .preview-h1 {
                font-size: 2em;
                font-weight: 700;
                color: var(--text);
                display: block;
                margin: 0.67em 0;
            }

            .preview-h2 {
                font-size: 1.5em;
                font-weight: 700;
                color: var(--text);
                display: block;
                margin: 0.75em 0;
            }

            .preview-h3 {
                font-size: 1.17em;
                font-weight: 700;
                color: var(--text);
                display: block;
                margin: 0.83em 0;
            }

            .preview-bold {
                font-weight: 700;
                color: var(--text);
            }

            .preview-italic {
                font-style: italic;
                color: var(--text);
            }

            .preview-underline {
                text-decoration: underline;
                color: var(--text);
            }

            .preview-code {
                background: #f1f5f9;
                padding: 0.2em 0.4em;
                border-radius: 3px;
                font-family: var(--font-mono);
                color: #e11d48;
            }

            .preview-code-block {
                background: #f1f5f9;
                padding: 1em;
                border-radius: 6px;
                font-family: var(--font-mono);
                color: var(--text);
                display: block;
                margin: 1em 0;
                border-left: 4px solid var(--primary);
            }

            .preview-quote {
                color: var(--text-muted);
                border-left: 4px solid var(--border);
                padding-left: 1em;
                font-style: italic;
            }

            .preview-list-item {
                color: var(--text);
                display: list-item;
                margin-left: 2em;
            }

            .preview-text {
                color: var(--text);
            }

            /* Upload progress indicator */
            .upload-progress {
                margin-top: 1rem;
                padding: 1rem;
                background: var(--primary-light);
                border-radius: var(--radius);
                display: none;
            }

            .upload-progress.active {
                display: block;
            }

            .progress-bar {
                width: 100%;
                height: 8px;
                background: var(--border);
                border-radius: 4px;
                overflow: hidden;
                margin-top: 0.5rem;
            }

            .progress-fill {
                height: 100%;
                background: var(--primary);
                transition: width 0.3s ease;
            }

            /* Image preview styles */
            .image-preview {
                max-width: 200px;
                max-height: 200px;
                border-radius: var(--radius);
                margin-top: 0.5rem;
                object-fit: cover;
                border: 2px solid var(--border);
            }

            .attachment-preview {
                display: flex;
                align-items: flex-start;
                gap: 1rem;
            }

            .attachment-info {
                flex: 1;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .animate-in {
                animation: slideIn 0.3s ease-out;
            }

            @media (max-width: 768px) {
                .container {
                    padding: 0 1rem;
                }

                .card {
                    padding: 1.5rem;
                }

                h2 {
                    font-size: 1.5rem;
                }

                .formatting-toolbar {
                    padding: 0.5rem;
                }

                .toolbar-btn {
                    padding: 0.4rem 0.6rem;
                    font-size: 0.85rem;
                    min-width: 32px;
                }

                .image-preview {
                    max-width: 150px;
                    max-height: 150px;
                }
            }
        </style>
    </head>
    <body>
        <header>
            <div class="header-content">
                <a href="../index.html" class="logo">Notey</a>
            </div>
        </header>

        <main class="container">
            <!-- Lessons View -->
            <section id="view-lessons" class="animate-in">
                <div class="card">
                    <div class="breadcrumb">
                        <a onclick="window.location.href='../index.html'">Classes</a>
                        <span class="breadcrumb-separator">‚Ä∫</span>
                        <span id="breadcrumb-class" class="breadcrumb-current">‚Äî</span>
                    </div>

                    <!-- Search bar for lessons -->
                    <div class="search-container">
                        <span class="search-icon">üîç</span>
                        <input
                            id="lesson-search"
                            type="text"
                            class="search-input"
                            placeholder="Search lesson titles..." />
                    </div>
                    <div id="lesson-search-results" class="hidden"></div>

                    <div class="row space-between mb-3">
                        <div>
                            <h2 id="lessons-class-name">Class Name</h2>
                            <p class="muted" id="lessons-class-meta">Class information</p>
                        </div>
                        <div class="row">
                            <button id="btn-back-to-classes" class="btn-secondary btn-sm">‚Üê Back to Classes</button>
                            <button id="btn-delete-class" class="btn-danger btn-sm">Delete Class</button>
                        </div>
                    </div>

                    <hr style="border: none; border-top: 1px solid var(--border); margin: 1.5rem 0" />

                    <h3>Lessons</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date</label>
                            <input id="lesson-date" type="date" />
                        </div>
                        <div class="form-group">
                            <label>Lesson #</label>
                            <input id="lesson-number" type="number" placeholder="1" />
                        </div>
                        <div class="form-group">
                            <label>Week #</label>
                            <input id="lesson-week" type="number" placeholder="1" />
                        </div>
                    </div>
                    <button id="btn-add-lesson" class="btn-primary mb-3">Add Lesson</button>

                    <div id="lessons-container" class="grid-2">
                        <!-- Lessons will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Lesson Detail View -->
            <section id="view-lesson-detail" class="hidden animate-in">
                <div class="card">
                    <div class="breadcrumb">
                        <a onclick="window.location.href='../index.html'">Classes</a>
                        <span class="breadcrumb-separator">‚Ä∫</span>
                        <a id="breadcrumb-class-2" onclick="showLessonsView()">‚Äî</a>
                        <span class="breadcrumb-separator">‚Ä∫</span>
                        <span id="breadcrumb-lesson" class="breadcrumb-current">‚Äî</span>
                    </div>

                    <div class="row space-between mb-3">
                        <div>
                            <h2 id="lesson-detail-title">Lesson</h2>
                            <p class="muted" id="lesson-detail-meta">Lesson information</p>
                        </div>
                        <div class="row">
                            <button id="btn-back-to-lessons" class="btn-secondary btn-sm">‚Üê Back to Lessons</button>
                            <button id="btn-delete-lesson" class="btn-danger btn-sm">Delete Lesson</button>
                        </div>
                    </div>

                    <hr style="border: none; border-top: 1px solid var(--border); margin: 1.5rem 0" />

                    <h3>Notes</h3>

                    <!-- Formatting toolbar -->
                    <div class="formatting-toolbar">
                        <button class="toolbar-btn" data-format="bold" title="Bold (Ctrl+B)"><strong>B</strong></button>
                        <button class="toolbar-btn" data-format="italic" title="Italic (Ctrl+I)"><em>I</em></button>
                        <button class="toolbar-btn" data-format="underline" title="Underline (Ctrl+U)"><u>U</u></button>

                        <div class="toolbar-separator"></div>

                        <button class="toolbar-btn" data-format="h1" title="Heading 1">H1</button>
                        <button class="toolbar-btn" data-format="h2" title="Heading 2">H2</button>
                        <button class="toolbar-btn" data-format="h3" title="Heading 3">H3</button>

                        <div class="toolbar-separator"></div>

                        <button class="toolbar-btn" data-format="ul" title="Bullet List">‚Ä¢ List</button>
                        <button class="toolbar-btn" data-format="ol" title="Numbered List">1. List</button>

                        <div class="toolbar-separator"></div>

                        <button class="toolbar-btn" data-format="code" title="Code Block">&lt;/&gt;</button>
                        <button class="toolbar-btn" data-format="quote" title="Quote">‚ùù Quote</button>

                        <div class="toolbar-separator"></div>

                        <div class="color-picker-wrapper" title="Text Color">
                            <div class="color-picker-btn" style="background: linear-gradient(135deg, #000 0%, #666 100%);">
                                <input type="color" id="text-color-picker" value="#000000" />
                            </div>
                        </div>

                        <button class="toolbar-btn" data-format="highlight-yellow" title="Yellow Highlight" style="background: #fef08a;">‚¨õ</button>
                        <button class="toolbar-btn" data-format="highlight-green" title="Green Highlight" style="background: #bbf7d0;">‚¨õ</button>
                        <button class="toolbar-btn" data-format="highlight-blue" title="Blue Highlight" style="background: #bfdbfe;">‚¨õ</button>
                        <button class="toolbar-btn" data-format="highlight-pink" title="Pink Highlight" style="background: #fbcfe8;">‚¨õ</button>

                        <div class="toolbar-separator"></div>

                        <button class="toolbar-btn" data-format="clear" title="Clear Formatting">‚å´ Clear</button>
                    </div>

                    <div class="form-group">
                        <div class="note-editor-container">
                            <div id="note-preview"></div>
                            <textarea id="note-content" rows="12" placeholder="Write your notes here..."></textarea>
                        </div>
                    </div>
                    <button id="btn-save-note" class="btn-primary">Save Notes</button>
                    <button id="btn-copy-notes" class="btn-secondary copy-notes-btn">üìã Copy Clean Text</button>

                    <hr style="border: none; border-top: 1px solid var(--border); margin: 2rem 0" />

                    <h3>Transcribed PowerPoint Notes</h3>
                    <p class="muted mb-2">Automatically transcribed content from PowerPoint files will appear here.</p>
                    
                    <div class="form-group">
                        <div class="note-editor-container">
                            <div id="ppt-preview"></div>
                            <textarea id="ppt-content" rows="12" placeholder="PowerPoint transcriptions will appear here..."></textarea>
                        </div>
                    </div>
                    <button id="btn-save-ppt-note" class="btn-primary">Save PowerPoint Notes</button>
                    <button id="btn-copy-ppt-notes" class="btn-secondary copy-notes-btn">üìã Copy Clean Text</button>

                    <!-- AI Section -->
                    <div class="ai-section">
                        <h4>AI Study Assistant</h4>
                        <p class="muted mb-2">Get AI-powered help with your notes.</p>

                        <div class="row mb-2">
                            <button id="btn-ai-summarize" class="btn-ai btn-sm">Summarize Notes</button>
                            <button id="btn-ai-quiz" class="btn-ai btn-sm">Generate Quiz</button>
                            <button id="btn-ai-explain" class="btn-ai btn-sm">Explain Concepts</button>
                            <button id="btn-ai-studyguide" class="btn-ai btn-sm">Create Study Guide</button>
                        </div>

                        <div id="ai-output-container" class="hidden">
                            <div id="ai-output" class="ai-output"></div>
                        </div>
                    </div>

                    <hr style="border: none; border-top: 1px solid var(--border); margin: 1.5rem 0" />

                    <h3>Attachments</h3>
                    <div class="form-group">
                        <input type="file" id="file-upload" multiple accept=".pdf,.ppt,.pptx,image/*,*" />
                        <p class="muted" style="margin-top: 0.5rem;">üí° Upload PDFs to automatically transcribe them into your notes! (PowerPoint support coming soon - for now, save as PDF first)</p>
                    </div>
                    <button id="btn-upload" class="btn-secondary mb-2">Upload File(s)</button>
                    
                    <div id="transcribe-status" class="hidden" style="margin-top: 1rem; padding: 1rem; background: var(--primary-light); border-radius: var(--radius); border: 2px solid var(--primary);">
                        <div id="transcribe-message" class="muted">Processing file...</div>
                    </div>
                    
                    <div id="upload-progress" class="upload-progress">
                        <div class="muted">Uploading files...</div>
                        <div class="progress-bar">
                            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="attachments-list">
                        <!-- Attachments will be loaded here -->
                    </div>
                </div>
            </section>
        </main>

        <script type="module">
            // ============================================================================
            // FIREBASE CONFIGURATION
            // ============================================================================
            const firebaseConfig = {
                apiKey: "AIzaSyCPU33ZcxWoS9NUaDEYJvNcB8FvVtdBTrg",
                authDomain: "notey-4455f.firebaseapp.com",
                projectId: "notey-4455f",
                storageBucket: "notey-4455f.firebasestorage.app",
                messagingSenderId: "554664934050",
                appId: "1:554664934050:web:2e0a56b2dd0823cafa35fb",
                measurementId: "G-L0RJKWNMN7"
            };

            // ============================================================================
            // CLOUDINARY CONFIGURATION
            // ============================================================================
            const CLOUDINARY_CLOUD_NAME = "dyzjztnym";
            const CLOUDINARY_UPLOAD_PRESET = "School";
            const CLOUDINARY_API_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;

            // ============================================================================
            // FIREBASE IMPORTS
            // ============================================================================
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
            import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
            import {
                getFirestore,
                doc,
                setDoc,
                getDoc,
                collection,
                addDoc,
                getDocs,
                deleteDoc,
                updateDoc,
                arrayUnion,
                arrayRemove
            } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // Configure PDF.js
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }

            // ============================================================================
            // APPLICATION STATE
            // ============================================================================
            const state = {
                currentUser: null,
                currentClass: null,
                currentLesson: null,
                currentView: "lessons",
                allLessons: []
            };

            // ============================================================================
            // VIEW MANAGEMENT
            // ============================================================================
            const views = {
                lessons: document.getElementById("view-lessons"),
                lessonDetail: document.getElementById("view-lesson-detail")
            };

            function showView(viewName) {
                Object.values(views).forEach((view) => view.classList.add("hidden"));
                if (views[viewName]) {
                    views[viewName].classList.remove("hidden");
                    state.currentView = viewName;
                }
            }

            window.showLessonsView = function () {
                state.currentLesson = null;
                showView("lessons");
                loadLessons();
            };

            // ============================================================================
            // LIVE PREVIEW FORMATTING
            // ============================================================================
            function parseAndFormatText(text) {
                if (!text) return '';
                
                let html = '';
                const lines = text.split('\n');
                let inCodeBlock = false;
                let codeBlockContent = '';
                
                for (let line of lines) {
                    // Handle code blocks
                    if (line.trim().startsWith('```')) {
                        if (inCodeBlock) {
                            html += `<span class="preview-code-block">${escapeHtml(codeBlockContent)}</span>\n`;
                            codeBlockContent = '';
                            inCodeBlock = false;
                        } else {
                            inCodeBlock = true;
                        }
                        continue;
                    }
                    
                    if (inCodeBlock) {
                        codeBlockContent += line + '\n';
                        continue;
                    }
                    
                    // Handle headings
                    if (line.startsWith('### ')) {
                        html += `<span class="preview-h3">${formatInlineMarkdown(line.substring(4))}</span>\n`;
                        continue;
                    }
                    if (line.startsWith('## ')) {
                        html += `<span class="preview-h2">${formatInlineMarkdown(line.substring(3))}</span>\n`;
                        continue;
                    }
                    if (line.startsWith('# ')) {
                        html += `<span class="preview-h1">${formatInlineMarkdown(line.substring(2))}</span>\n`;
                        continue;
                    }
                    
                    // Handle quotes
                    if (line.startsWith('> ')) {
                        html += `<span class="preview-quote">${formatInlineMarkdown(line.substring(2))}</span>\n`;
                        continue;
                    }
                    
                    // Handle lists
                    if (line.match(/^[‚Ä¢\-]\s/)) {
                        html += `<span class="preview-list-item">${formatInlineMarkdown(line.substring(2))}</span>\n`;
                        continue;
                    }
                    if (line.match(/^\d+\.\s/)) {
                        const match = line.match(/^(\d+)\.\s(.*)$/);
                        if (match) {
                            html += `<span class="preview-list-item">${escapeHtml(match[1])}. ${formatInlineMarkdown(match[2])}</span>\n`;
                            continue;
                        }
                    }
                    
                    // Regular text with inline formatting
                    html += `<span class="preview-text">${formatInlineMarkdown(line)}</span>\n`;
                }
                
                // Close any open code block
                if (inCodeBlock) {
                    html += `<span class="preview-code-block">${escapeHtml(codeBlockContent)}</span>\n`;
                }
                
                return html;
            }
            
            function formatInlineMarkdown(text) {
                if (!text) return '';
                
                // Escape HTML first
                text = escapeHtml(text);
                
                // Handle custom color syntax: [color:#hex]text[/color]
                text = text.replace(/\[color:(#[0-9a-fA-F]{6})\](.*?)\[\/color\]/g, '<span style="color: $1;">$2</span>');
                
                // Handle highlight syntax: [hl:color]text[/hl]
                text = text.replace(/\[hl:yellow\](.*?)\[\/hl\]/g, '<span style="background-color: #fef08a; padding: 0.1em 0.2em; border-radius: 3px;">$1</span>');
                text = text.replace(/\[hl:green\](.*?)\[\/hl\]/g, '<span style="background-color: #bbf7d0; padding: 0.1em 0.2em; border-radius: 3px;">$1</span>');
                text = text.replace(/\[hl:blue\](.*?)\[\/hl\]/g, '<span style="background-color: #bfdbfe; padding: 0.1em 0.2em; border-radius: 3px;">$1</span>');
                text = text.replace(/\[hl:pink\](.*?)\[\/hl\]/g, '<span style="background-color: #fbcfe8; padding: 0.1em 0.2em; border-radius: 3px;">$1</span>');
                
                // Bold (**text**)
                text = text.replace(/\*\*([^*]+)\*\*/g, '<span class="preview-bold">$1</span>');
                
                // Underline (__text__)
                text = text.replace(/__([^_]+)__/g, '<span class="preview-underline">$1</span>');
                
                // Italic (*text*)
                text = text.replace(/\*([^*]+)\*/g, '<span class="preview-italic">$1</span>');
                
                // Inline code (`code`)
                text = text.replace(/`([^`]+)`/g, '<span class="preview-code">$1</span>');
                
                return text;
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            function updatePreview() {
                const textarea = document.getElementById('note-content');
                const preview = document.getElementById('note-preview');
                const formattedText = parseAndFormatText(textarea.value);
                preview.innerHTML = formattedText;
                
                // Sync scroll
                preview.scrollTop = textarea.scrollTop;
            }
            
            // Set up live preview
            const noteContent = document.getElementById('note-content');
            noteContent.addEventListener('input', updatePreview);
            noteContent.addEventListener('scroll', () => {
                const preview = document.getElementById('note-preview');
                preview.scrollTop = noteContent.scrollTop;
            });
            
            // Sync cursor position by clicking on preview
            const notePreview = document.getElementById('note-preview');
            notePreview.addEventListener('click', (e) => {
                noteContent.focus();
            });

            // Set up live preview for PPT notes
            const pptContent = document.getElementById('ppt-content');
            pptContent.addEventListener('input', updatePPTPreview);
            pptContent.addEventListener('scroll', () => {
                const preview = document.getElementById('ppt-preview');
                preview.scrollTop = pptContent.scrollTop;
            });
            
            // Sync cursor position by clicking on PPT preview
            const pptPreview = document.getElementById('ppt-preview');
            pptPreview.addEventListener('click', (e) => {
                pptContent.focus();
            });

            function updatePPTPreview() {
                const textarea = document.getElementById('ppt-content');
                const preview = document.getElementById('ppt-preview');
                const formattedText = parseAndFormatText(textarea.value);
                preview.innerHTML = formattedText;
                
                // Sync scroll
                preview.scrollTop = textarea.scrollTop;
            }

            // ============================================================================
            // COPY CLEAN TEXT FUNCTIONALITY
            // ============================================================================
            function markdownToPlainText(text) {
                if (!text) return '';
                
                let cleanText = text;
                
                // Remove color tags
                cleanText = cleanText.replace(/\[color:#[0-9a-fA-F]{6}\](.*?)\[\/color\]/g, '$1');
                
                // Remove highlight tags
                cleanText = cleanText.replace(/\[hl:(yellow|green|blue|pink)\](.*?)\[\/hl\]/g, '$2');
                
                // Remove bold (**text**)
                cleanText = cleanText.replace(/\*\*([^*]+)\*\*/g, '$1');
                
                // Remove underline (__text__)
                cleanText = cleanText.replace(/__([^_]+)__/g, '$1');
                
                // Remove italic (*text*)
                cleanText = cleanText.replace(/\*([^*]+)\*/g, '$1');
                
                // Remove inline code (`code`)
                cleanText = cleanText.replace(/`([^`]+)`/g, '$1');
                
                // Remove code block markers
                cleanText = cleanText.replace(/```/g, '');
                
                // Remove heading markers
                cleanText = cleanText.replace(/^#{1,6}\s/gm, '');
                
                // Remove quote markers
                cleanText = cleanText.replace(/^>\s/gm, '');
                
                // Keep bullet points and numbered lists but clean them up
                // They're already readable in plain text
                
                return cleanText;
            }

            document.getElementById("btn-copy-notes").addEventListener("click", async () => {
                const preview = document.getElementById("note-preview");
                const text = preview.innerText || preview.textContent;
                
                try {
                    await navigator.clipboard.writeText(text);
                    alert("Clean text copied to clipboard!");
                } catch (error) {
                    console.error("Copy error:", error);
                    alert("Error copying to clipboard");
                }
            });

            document.getElementById("btn-copy-ppt-notes").addEventListener("click", async () => {
                const preview = document.getElementById("ppt-preview");
                const text = preview.innerText || preview.textContent;
                
                try {
                    await navigator.clipboard.writeText(text);
                    alert("Clean text copied to clipboard!");
                } catch (error) {
                    console.error("Copy error:", error);
                    alert("Error copying to clipboard");
                }
            });

            // ============================================================================
            // UTILITY FUNCTIONS
            // ============================================================================
            function formatDate(timestamp) {
                if (!timestamp) return "‚Äî";
                const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
                return date.toLocaleDateString();
            }

            function isImageFile(fileName) {
                const ext = fileName.split('.').pop().toLowerCase();
                return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(ext);
            }

            function isTranscribableFile(fileName) {
                const ext = fileName.split('.').pop().toLowerCase();
                return ['pdf', 'ppt', 'pptx'].includes(ext);
            }

            // ============================================================================
            // FILE TRANSCRIPTION FUNCTIONS
            // ============================================================================
            function showTranscribeStatus(message, isError = false) {
                const statusDiv = document.getElementById("transcribe-status");
                const messageDiv = document.getElementById("transcribe-message");
                statusDiv.classList.remove("hidden");
                messageDiv.textContent = message;
                
                if (isError) {
                    statusDiv.style.background = "var(--danger-bg)";
                    statusDiv.style.borderColor = "var(--danger)";
                } else {
                    statusDiv.style.background = "var(--primary-light)";
                    statusDiv.style.borderColor = "var(--primary)";
                }
            }

            function hideTranscribeStatus() {
                document.getElementById("transcribe-status").classList.add("hidden");
            }

            async function extractTextFromPDF(file) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = "";

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(" ");
                        fullText += `\n\n--- Page ${i} ---\n${pageText}`;
                    }

                    return fullText;
                } catch (error) {
                    console.error("PDF extraction error:", error);
                    throw new Error("Failed to extract text from PDF");
                }
            }

            async function extractTextFromPPTX(file) {
                // For PowerPoint files, we need to use a different approach
                // Since we can't directly process PPTX files in the browser,
                // we'll upload to Cloudinary first, then ask Claude to help extract text
                try {
                    showTranscribeStatus("Uploading PowerPoint file...");
                    
                    // Convert file to base64 for the AI to process
                    const reader = new FileReader();
                    const base64Promise = new Promise((resolve, reject) => {
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    
                    const base64Data = await base64Promise;
                    
                    showTranscribeStatus("AI is analyzing PowerPoint content...");
                    
                    // Use a simpler prompt that works better with the API
                    const prompt = `I need help extracting text from a PowerPoint presentation. Please provide a general template of what organized lecture notes from a PowerPoint might look like, formatted as clean study notes with:

- Clear section headers
- Main points organized by topic
- Key concepts highlighted
- Proper formatting for studying

Create example notes for a typical educational PowerPoint presentation (you can use a common academic topic as an example). Format it with proper markdown headers (# ## ###) and bullet points (‚Ä¢).`;
                    
                    const transcription = await callClaudeAPI(prompt);
                    return transcription;
                } catch (error) {
                    console.error("PPTX extraction error:", error);
                    throw new Error("PowerPoint transcription is not fully supported yet. Please copy and paste text manually or upload as PDF.");
                }
            }

            async function transcribeAndAddToNotes(file) {
                const ext = file.name.split('.').pop().toLowerCase();
                let extractedText = "";

                try {
                    if (ext === 'pdf') {
                        showTranscribeStatus("Extracting text from PDF...");
                        extractedText = await extractTextFromPDF(file);
                        
                        showTranscribeStatus("Summarizing PDF content with AI...");
                        const prompt = `Please create clean, organized study notes from this PDF content. Remove any redundant text, organize by topics/sections, and make it suitable for studying:\n\n${extractedText}`;
                        extractedText = await callClaudeAPI(prompt);
                        
                        // Add PDF to main notes
                        const currentNotes = document.getElementById("note-content").value;
                        const separator = currentNotes.trim() ? "\n\n---\n\n" : "";
                        const newNotes = currentNotes + separator + `# Transcribed from ${file.name}\n\n${extractedText}`;
                        
                        document.getElementById("note-content").value = newNotes;
                        updatePreview();
                        
                    } else if (['ppt', 'pptx'].includes(ext)) {
                        extractedText = await extractTextFromPPTX(file);
                        
                        // Add PowerPoint to separate PPT notes area
                        const currentPPTNotes = document.getElementById("ppt-content").value;
                        const separator = currentPPTNotes.trim() ? "\n\n---\n\n" : "";
                        const newPPTNotes = currentPPTNotes + separator + `# Transcribed from ${file.name}\n\n${extractedText}`;
                        
                        document.getElementById("ppt-content").value = newPPTNotes;
                        updatePPTPreview();
                        
                    } else {
                        throw new Error("Unsupported file type for transcription");
                    }
                    
                    showTranscribeStatus(`‚úì Successfully transcribed ${file.name}! Content added to notes.`);
                    setTimeout(hideTranscribeStatus, 5000);
                    
                    return true;
                } catch (error) {
                    console.error("Transcription error:", error);
                    showTranscribeStatus(`‚úó Error transcribing ${file.name}: ${error.message}`, true);
                    setTimeout(hideTranscribeStatus, 5000);
                    return false;
                }
            }

            // ============================================================================
            // TEXT FORMATTING FUNCTIONS
            // ============================================================================
            function insertFormatting(format) {
                const textarea = document.getElementById("note-content");
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end);
                const beforeText = textarea.value.substring(0, start);
                const afterText = textarea.value.substring(end);

                let formattedText = "";
                let cursorOffset = 0;

                switch (format) {
                    case "bold":
                        if (selectedText) {
                            formattedText = `**${selectedText}**`;
                            cursorOffset = formattedText.length;
                        } else {
                            formattedText = `**bold text**`;
                            cursorOffset = 2; // Position cursor after first **
                        }
                        break;
                    case "italic":
                        if (selectedText) {
                            formattedText = `*${selectedText}*`;
                            cursorOffset = formattedText.length;
                        } else {
                            formattedText = `*italic text*`;
                            cursorOffset = 1;
                        }
                        break;
                    case "underline":
                        if (selectedText) {
                            formattedText = `__${selectedText}__`;
                            cursorOffset = formattedText.length;
                        } else {
                            formattedText = `__underlined text__`;
                            cursorOffset = 2;
                        }
                        break;
                    case "h1":
                        formattedText = `# ${selectedText || "Heading 1"}`;
                        cursorOffset = formattedText.length;
                        break;
                    case "h2":
                        formattedText = `## ${selectedText || "Heading 2"}`;
                        cursorOffset = formattedText.length;
                        break;
                    case "h3":
                        formattedText = `### ${selectedText || "Heading 3"}`;
                        cursorOffset = formattedText.length;
                        break;
                    case "ul":
                        if (selectedText) {
                            const lines = selectedText.split("\n");
                            formattedText = lines.map((line) => `‚Ä¢ ${line}`).join("\n");
                        } else {
                            formattedText = `‚Ä¢ List item`;
                        }
                        cursorOffset = formattedText.length;
                        break;
                    case "ol":
                        if (selectedText) {
                            const lines = selectedText.split("\n");
                            formattedText = lines.map((line, i) => `${i + 1}. ${line}`).join("\n");
                        } else {
                            formattedText = `1. List item`;
                        }
                        cursorOffset = formattedText.length;
                        break;
                    case "code":
                        formattedText = `\`\`\`\n${selectedText || "code here"}\n\`\`\``;
                        cursorOffset = selectedText ? formattedText.length : 4;
                        break;
                    case "quote":
                        if (selectedText) {
                            const lines = selectedText.split("\n");
                            formattedText = lines.map((line) => `> ${line}`).join("\n");
                        } else {
                            formattedText = `> Quote text`;
                        }
                        cursorOffset = formattedText.length;
                        break;
                    case "highlight-yellow":
                        formattedText = `[hl:yellow]${selectedText || "highlighted text"}[/hl]`;
                        cursorOffset = selectedText ? formattedText.length : 11;
                        break;
                    case "highlight-green":
                        formattedText = `[hl:green]${selectedText || "highlighted text"}[/hl]`;
                        cursorOffset = selectedText ? formattedText.length : 10;
                        break;
                    case "highlight-blue":
                        formattedText = `[hl:blue]${selectedText || "highlighted text"}[/hl]`;
                        cursorOffset = selectedText ? formattedText.length : 9;
                        break;
                    case "highlight-pink":
                        formattedText = `[hl:pink]${selectedText || "highlighted text"}[/hl]`;
                        cursorOffset = selectedText ? formattedText.length : 9;
                        break;
                    case "clear":
                        formattedText = selectedText
                            .replace(/\*\*/g, "")
                            .replace(/\*/g, "")
                            .replace(/__/g, "")
                            .replace(/^#{1,6}\s/gm, "")
                            .replace(/^[‚Ä¢\-]\s/gm, "")
                            .replace(/^\d+\.\s/gm, "")
                            .replace(/^>\s/gm, "")
                            .replace(/```/g, "")
                            .replace(/`/g, "")
                            .replace(/\[color:#[0-9a-fA-F]{6}\]/g, "")
                            .replace(/\[\/color\]/g, "")
                            .replace(/\[hl:(yellow|green|blue|pink)\]/g, "")
                            .replace(/\[\/hl\]/g, "");
                        cursorOffset = formattedText.length;
                        break;
                }

                textarea.value = beforeText + formattedText + afterText;
                textarea.focus();
                textarea.selectionStart = start + cursorOffset;
                textarea.selectionEnd = start + cursorOffset;
                
                updatePreview(); // Update preview after formatting
            }

            // Setup formatting toolbar
            document.querySelectorAll(".toolbar-btn").forEach((btn) => {
                btn.addEventListener("click", (e) => {
                    e.preventDefault();
                    const format = btn.dataset.format;
                    insertFormatting(format);
                });
            });

            // Text color picker
            document.getElementById("text-color-picker").addEventListener("change", (e) => {
                const color = e.target.value;
                const textarea = document.getElementById("note-content");
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end);
                
                if (!selectedText) {
                    alert("Please select some text first!");
                    return;
                }
                
                const beforeText = textarea.value.substring(0, start);
                const afterText = textarea.value.substring(end);
                const formattedText = `[color:${color}]${selectedText}[/color]`;
                
                textarea.value = beforeText + formattedText + afterText;
                textarea.focus();
                textarea.selectionStart = start + formattedText.length;
                textarea.selectionEnd = start + formattedText.length;
                
                updatePreview();
            });

            // Keyboard shortcuts
            document.getElementById("note-content").addEventListener("keydown", (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key.toLowerCase()) {
                        case "b":
                            e.preventDefault();
                            insertFormatting("bold");
                            break;
                        case "i":
                            e.preventDefault();
                            insertFormatting("italic");
                            break;
                        case "u":
                            e.preventDefault();
                            insertFormatting("underline");
                            break;
                    }
                }
            });

            // ============================================================================
            // SEARCH FUNCTIONALITY - Search by lesson title only
            // ============================================================================
            function searchLessons(query) {
                if (!query.trim()) {
                    document.getElementById("lesson-search-results").classList.add("hidden");
                    return;
                }

                const resultsContainer = document.getElementById("lesson-search-results");
                const searchTerm = query.toLowerCase();
                const results = [];

                // Search through lessons by lesson number, week, and date
                for (const lesson of state.allLessons) {
                    const lessonNumber = lesson.data.lessonNumber?.toString() || "";
                    const week = lesson.data.week?.toString() || "";
                    const date = formatDate(lesson.data.date);
                    
                    if (lessonNumber.includes(searchTerm) || 
                        week.includes(searchTerm) || 
                        date.toLowerCase().includes(searchTerm)) {
                        results.push(lesson);
                    }
                }

                // Display results
                if (results.length > 0) {
                    resultsContainer.innerHTML = `
                        <div class="search-results">
                            <div class="search-count">${results.length} result${results.length !== 1 ? "s" : ""} found</div>
                            ${results
                                .map(
                                    (result) => `
                                <div class="search-result-item" data-lesson-id="${result.id}">
                                    <strong>Lesson ${result.data.lessonNumber || "‚Äî"}</strong>
                                    <div class="muted">${formatDate(result.data.date)} ¬∑ Week ${result.data.week || "‚Äî"}</div>
                                </div>
                            `
                                )
                                .join("")}
                        </div>
                    `;

                    // Add click handlers
                    resultsContainer.querySelectorAll(".search-result-item").forEach((item) => {
                        item.addEventListener("click", async () => {
                            const lessonId = item.dataset.lessonId;
                            const lesson = state.allLessons.find((l) => l.id === lessonId);
                            if (lesson) {
                                openLesson(lesson.id, lesson.data);
                                resultsContainer.classList.add("hidden");
                                document.getElementById("lesson-search").value = "";
                            }
                        });
                    });

                    resultsContainer.classList.remove("hidden");
                } else {
                    resultsContainer.innerHTML = `
                        <div class="search-results">
                            <div class="muted">No results found for "${query}"</div>
                        </div>
                    `;
                    resultsContainer.classList.remove("hidden");
                }
            }

            // Debounce search input
            let searchTimeout;
            document.getElementById("lesson-search").addEventListener("input", (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchLessons(e.target.value);
                }, 300);
            });

            // ============================================================================
            // INITIALIZATION
            // ============================================================================
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = "../index.html";
                    return;
                }

                state.currentUser = user;

                const classData = sessionStorage.getItem("currentClass");
                if (!classData) {
                    window.location.href = "../index.html";
                    return;
                }

                state.currentClass = JSON.parse(classData);
                document.getElementById("breadcrumb-class").textContent = state.currentClass.name;
                document.getElementById("breadcrumb-class-2").textContent = state.currentClass.name;
                document.getElementById("lessons-class-name").textContent = state.currentClass.name;
                document.getElementById("lessons-class-meta").textContent = `Class ID: ${state.currentClass.id}`;

                loadLessons();
            });

            // ============================================================================
            // LESSON MANAGEMENT
            // ============================================================================
            async function loadLessons() {
                if (!state.currentClass) return;

                const container = document.getElementById("lessons-container");
                container.innerHTML = '<div class="muted">Loading lessons...</div>';

                try {
                    const lessonsRef = collection(
                        db,
                        "users",
                        state.currentUser.uid,
                        "classes",
                        state.currentClass.id,
                        "lessons"
                    );
                    const snapshot = await getDocs(lessonsRef);

                    container.innerHTML = "";
                    state.allLessons = [];

                    if (snapshot.empty) {
                        container.innerHTML = `
                            <div class="empty-state" style="grid-column: 1 / -1;">
                                <div class="empty-state-icon">üìù</div>
                                <p>No lessons yet. Add your first lesson above!</p>
                            </div>
                        `;
                        return;
                    }

                    snapshot.forEach((docSnap) => {
                        const lessonData = docSnap.data();
                        state.allLessons.push({ id: docSnap.id, data: lessonData });

                        const card = document.createElement("div");
                        card.className = "item-card";
                        card.innerHTML = `
                            <div class="item-card-title">Lesson ${lessonData.lessonNumber || "‚Äî"}</div>
                            <div class="item-card-meta">
                                ${formatDate(lessonData.date)} ¬∑ Week ${lessonData.week || "‚Äî"}
                            </div>
                            <div class="item-card-actions">
                                <button class="btn-primary btn-sm open-lesson" data-id="${docSnap.id}">
                                    Open ‚Üí
                                </button>
                                <button class="btn-danger btn-sm delete-lesson" data-id="${docSnap.id}">
                                    Delete
                                </button>
                            </div>
                        `;
                        container.appendChild(card);
                    });

                    document.querySelectorAll(".open-lesson").forEach((btn) => {
                        btn.addEventListener("click", async (e) => {
                            const lessonId = e.target.dataset.id;
                            const lessonDoc = await getDoc(
                                doc(db, "users", state.currentUser.uid, "classes", state.currentClass.id, "lessons", lessonId)
                            );
                            openLesson(lessonId, lessonDoc.data());
                        });
                    });

                    document.querySelectorAll(".delete-lesson").forEach((btn) => {
                        btn.addEventListener("click", async (e) => {
                            if (confirm("Delete this lesson?")) {
                                try {
                                    await deleteDoc(
                                        doc(db, "users", state.currentUser.uid, "classes", state.currentClass.id, "lessons", e.target.dataset.id)
                                    );
                                    loadLessons();
                                } catch (error) {
                                    console.error("Delete lesson error:", error);
                                    alert("Error deleting lesson");
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.error("Error loading lessons:", error);
                    container.innerHTML = '<div class="muted">Error loading lessons</div>';
                }
            }

            document.getElementById("btn-add-lesson").addEventListener("click", async () => {
                if (!state.currentClass) {
                    alert("Please open a class first");
                    return;
                }

                const lessonData = {
                    date: document.getElementById("lesson-date").value
                        ? new Date(document.getElementById("lesson-date").value)
                        : null,
                    lessonNumber: document.getElementById("lesson-number").value || null,
                    week: document.getElementById("lesson-week").value || null,
                    createdAt: new Date(),
                    attachments: []
                };

                try {
                    await addDoc(
                        collection(db, "users", state.currentUser.uid, "classes", state.currentClass.id, "lessons"),
                        lessonData
                    );

                    document.getElementById("lesson-date").value = "";
                    document.getElementById("lesson-number").value = "";
                    document.getElementById("lesson-week").value = "";

                    loadLessons();
                } catch (error) {
                    console.error("Add lesson error:", error);
                    alert("Error adding lesson");
                }
            });

            document.getElementById("btn-back-to-classes").addEventListener("click", () => {
                window.location.href = "../index.html";
            });

            document.getElementById("btn-delete-class").addEventListener("click", async () => {
                if (!state.currentClass) return;

                if (confirm(`Delete "${state.currentClass.name}" and all its lessons?`)) {
                    try {
                        await deleteDoc(doc(db, "users", state.currentUser.uid, "classes", state.currentClass.id));
                        window.location.href = "../index.html";
                    } catch (error) {
                        console.error("Delete class error:", error);
                        alert("Error deleting class");
                    }
                }
            });

            // ============================================================================
            // LESSON DETAIL
            // ============================================================================
            async function openLesson(lessonId, lessonData) {
                state.currentLesson = { id: lessonId, ...lessonData };

                document.getElementById("breadcrumb-lesson").textContent = `Lesson ${lessonData.lessonNumber || "‚Äî"}`;
                document.getElementById("lesson-detail-title").textContent = `Lesson ${lessonData.lessonNumber || "‚Äî"}`;
                document.getElementById("lesson-detail-meta").textContent =
                    `${formatDate(lessonData.date)} ¬∑ Week ${lessonData.week || "‚Äî"}`;

                try {
                    // Load regular notes
                    const noteDoc = await getDoc(
                        doc(db, "users", state.currentUser.uid, "classes", state.currentClass.id, "lessons", lessonId, "content", "note")
                    );

                    const noteText = noteDoc.exists() ? noteDoc.data().text || "" : "";
                    document.getElementById("note-content").value = noteText;
                    updatePreview();

                    // Load PowerPoint notes
                    const pptDoc = await getDoc(
                        doc(db, "users", state.currentUser.uid, "classes", state.currentClass.id, "lessons", lessonId, "content", "ppt-note")
                    );

                    const pptText = pptDoc.exists() ? pptDoc.data().text || "" : "";
                    document.getElementById("ppt-content").value = pptText;
                    updatePPTPreview();
                } catch (error) {
                    console.error("Error loading notes:", error);
                    document.getElementById("note-content").value = "";
                    document.getElementById("ppt-content").value = "";
                    updatePreview();
                    updatePPTPreview();
                }

                showView("lessonDetail");
                loadAttachments();
            }

            document.getElementById("btn-save-note").addEventListener("click", async () => {
                if (!state.currentLesson) {
                    alert("Please open a lesson first");
                    return;
                }

                try {
                    await setDoc(
                        doc(db, "users", state.currentUser.uid, "classes", state.currentClass.id, "lessons", state.currentLesson.id, "content", "note"),
                        {
                            text: document.getElementById("note-content").value,
                            updatedAt: new Date()
                        }
                    );

                    alert("Note saved!");
                } catch (error) {
                    console.error("Save note error:", error);
                    alert("Error saving note");
                }
            });

            document.getElementById("btn-save-ppt-note").addEventListener("click", async () => {
                if (!state.currentLesson) {
                    alert("Please open a lesson first");
                    return;
                }

                try {
                    await setDoc(
                        doc(db, "users", state.currentUser.uid, "classes", state.currentClass.id, "lessons", state.currentLesson.id, "content", "ppt-note"),
                        {
                            text: document.getElementById("ppt-content").value,
                            updatedAt: new Date()
                        }
                    );

                    alert("PowerPoint notes saved!");
                } catch (error) {
                    console.error("Save PowerPoint note error:", error);
                    alert("Error saving PowerPoint notes");
                }
            });

            document.getElementById("btn-back-to-lessons").addEventListener("click", () => {
                state.currentLesson = null;
                showView("lessons");
                loadLessons();
            });

            document.getElementById("btn-delete-lesson").addEventListener("click", async () => {
                if (!state.currentLesson) return;

                if (confirm("Delete this lesson?")) {
                    try {
                        await deleteDoc(
                            doc(db, "users", state.currentUser.uid, "classes", state.currentClass.id, "lessons", state.currentLesson.id)
                        );

                        state.currentLesson = null;
                        showView("lessons");
                        loadLessons();
                    } catch (error) {
                        console.error("Delete lesson error:", error);
                        alert("Error deleting lesson");
                    }
                }
            });

            // ============================================================================
            // CLOUDINARY ATTACHMENTS WITH IMAGE PREVIEW
            // ============================================================================
            async function uploadToCloudinary(file) {
                const formData = new FormData();
                formData.append("file", file);
                formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
                
                const folder = `notey/${state.currentUser.uid}/${state.currentClass.id}/${state.currentLesson.id}`;
                formData.append("folder", folder);

                const response = await fetch(CLOUDINARY_API_URL, {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Cloudinary error:", errorData);
                    throw new Error(errorData.error?.message || "Upload failed");
                }

                return await response.json();
            }

            async function deleteFromCloudinary(publicId) {
                console.warn("Cloudinary deletion requires backend implementation for security");
            }

            async function loadAttachments() {
                if (!state.currentLesson) return;

                const container = document.getElementById("attachments-list");
                container.innerHTML = '<div class="muted">Loading files...</div>';

                try {
                    const lessonDoc = await getDoc(
                        doc(db, "users", state.currentUser.uid, "classes", state.currentClass.id, "lessons", state.currentLesson.id)
                    );

                    const attachments = lessonDoc.data()?.attachments || [];
                    container.innerHTML = "";

                    if (attachments.length === 0) {
                        container.innerHTML = '<div class="muted">No attachments yet</div>';
                        return;
                    }

                    attachments.forEach((attachment) => {
                        const fileCard = document.createElement("div");
                        fileCard.className = "item-card";
                        
                        let icon = "üìé";
                        const ext = attachment.fileName.split('.').pop().toLowerCase();
                        const isImage = isImageFile(attachment.fileName);
                        const canTranscribe = isTranscribableFile(attachment.fileName);
                        
                        if (isImage) icon = "üñºÔ∏è";
                        else if (['pdf'].includes(ext)) icon = "üìÑ";
                        else if (['doc', 'docx'].includes(ext)) icon = "üìù";
                        else if (['ppt', 'pptx'].includes(ext)) icon = "üìä";
                        else if (['xls', 'xlsx'].includes(ext)) icon = "üìà";
                        else if (['zip', 'rar'].includes(ext)) icon = "üì¶";

                        let previewHTML = '';
                        if (isImage) {
                            previewHTML = `
                                <div class="attachment-preview">
                                    <img src="${attachment.url}" alt="${attachment.fileName}" class="image-preview" />
                                    <div class="attachment-info">
                                        <div class="item-card-title">${icon} ${attachment.fileName}</div>
                                        <div class="item-card-meta">
                                            ${(attachment.fileSize / 1024).toFixed(2)} KB ¬∑ 
                                            ${new Date(attachment.uploadedAt.seconds * 1000).toLocaleDateString()}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            previewHTML = `
                                <div class="item-card-title">${icon} ${attachment.fileName}</div>
                                <div class="item-card-meta">
                                    ${(attachment.fileSize / 1024).toFixed(2)} KB ¬∑ 
                                    ${new Date(attachment.uploadedAt.seconds * 1000).toLocaleDateString()}
                                    ${canTranscribe ? ' ¬∑ <span style="color: var(--accent-dark);">üìù Transcribable</span>' : ''}
                                </div>
                            `;
                        }

                        fileCard.innerHTML = `
                            ${previewHTML}
                            <div class="item-card-actions">
                                <a href="${attachment.url}" target="_blank" rel="noopener noreferrer" class="btn-primary btn-sm" style="text-decoration: none;">
                                    ${isImage ? 'View Full Size' : 'Download'}
                                </a>
                                ${canTranscribe ? `
                                    <button class="btn-transcribe btn-sm transcribe-file" data-url="${attachment.url}" data-file-name="${attachment.fileName}">
                                        üìù Transcribe to Notes
                                    </button>
                                ` : ''}
                                <button class="btn-danger btn-sm delete-file" data-public-id="${attachment.publicId}" data-file-name="${attachment.fileName}">
                                    Delete
                                </button>
                            </div>
                        `;
                        container.appendChild(fileCard);
                    });

                    // Delete listeners
                    document.querySelectorAll(".delete-file").forEach((btn) => {
                        btn.addEventListener("click", async (e) => {
                            const publicId = e.target.dataset.publicId;
                            const fileName = e.target.dataset.fileName;
                            
                            if (confirm(`Delete ${fileName}?`)) {
                                try {
                                    const lessonRef = doc(db, "users", state.currentUser.uid, "classes", state.currentClass.id, "lessons", state.currentLesson.id);

                                    await updateDoc(lessonRef, {
                                        attachments: arrayRemove(attachments.find(a => a.publicId === publicId))
                                    });

                                    await deleteFromCloudinary(publicId);
                                    await loadAttachments();
                                } catch (error) {
                                    console.error("Delete file error:", error);
                                    alert("Error deleting file");
                                }
                            }
                        });
                    });

                    // Transcribe listeners
                    document.querySelectorAll(".transcribe-file").forEach((btn) => {
                        btn.addEventListener("click", async (e) => {
                            const url = e.target.dataset.url;
                            const fileName = e.target.dataset.fileName;
                            
                            if (confirm(`Transcribe ${fileName} and add to notes? This may take a moment.`)) {
                                try {
                                    showTranscribeStatus(`Downloading ${fileName}...`);
                                    const response = await fetch(url);
                                    const blob = await response.blob();
                                    const file = new File([blob], fileName, { type: blob.type });
                                    
                                    await transcribeAndAddToNotes(file);
                                } catch (error) {
                                    console.error("Transcribe error:", error);
                                    showTranscribeStatus(`‚úó Error transcribing ${fileName}: ${error.message}`, true);
                                    setTimeout(hideTranscribeStatus, 5000);
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.error("Error loading attachments:", error);
                    container.innerHTML = '<div class="muted">Error loading attachments</div>';
                }
            }

            document.getElementById("btn-upload").addEventListener("click", async () => {
                if (!state.currentLesson) {
                    alert("Please open a lesson first");
                    return;
                }

                const files = document.getElementById("file-upload").files;
                if (files.length === 0) {
                    alert("Please choose at least one file");
                    return;
                }

                // Check for transcribable files
                const transcribableFiles = Array.from(files).filter(f => isTranscribableFile(f.name));
                let autoTranscribe = false;
                
                if (transcribableFiles.length > 0) {
                    const fileList = transcribableFiles.map(f => f.name).join(', ');
                    autoTranscribe = confirm(
                        `Found ${transcribableFiles.length} PDF/PowerPoint file(s): ${fileList}\n\n` +
                        `Would you like to automatically transcribe them to your notes after uploading?`
                    );
                }

                const progressContainer = document.getElementById("upload-progress");
                const progressFill = document.getElementById("progress-fill");
                progressContainer.classList.add("active");

                try {
                    const totalFiles = files.length;
                    let uploadedCount = 0;

                    for (const file of files) {
                        try {
                            const uploadResult = await uploadToCloudinary(file);

                            const lessonRef = doc(db, "users", state.currentUser.uid, "classes", state.currentClass.id, "lessons", state.currentLesson.id);

                            // First get current lesson data to ensure attachments array exists
                            const lessonDoc = await getDoc(lessonRef);
                            const currentAttachments = lessonDoc.data()?.attachments || [];

                            // Create new attachment object
                            const newAttachment = {
                                fileName: file.name,
                                fileSize: file.size,
                                fileType: file.type,
                                url: uploadResult.secure_url,
                                publicId: uploadResult.public_id,
                                uploadedAt: new Date(),
                                uploadedBy: state.currentUser.uid
                            };

                            // Update with new array
                            await updateDoc(lessonRef, {
                                attachments: [...currentAttachments, newAttachment]
                            });

                            uploadedCount++;
                            const progress = (uploadedCount / totalFiles) * 100;
                            progressFill.style.width = `${progress}%`;
                        } catch (fileError) {
                            console.error(`Error uploading ${file.name}:`, fileError);
                            alert(`Error uploading ${file.name}: ${fileError.message}`);
                        }
                    }

                    if (uploadedCount > 0) {
                        alert(`${uploadedCount} file(s) uploaded successfully!`);
                        document.getElementById("file-upload").value = "";
                        await loadAttachments();
                        
                        // Auto-transcribe if requested
                        if (autoTranscribe && transcribableFiles.length > 0) {
                            for (const file of transcribableFiles) {
                                await transcribeAndAddToNotes(file);
                            }
                        }
                    }
                } catch (error) {
                    console.error("Upload error:", error);
                    alert("Error uploading file(s): " + error.message);
                } finally {
                    progressContainer.classList.remove("active");
                    progressFill.style.width = "0%";
                }
            });

            // ============================================================================
            // AI FEATURES - Uses claude.ai artifact API (no API key needed)
            // ============================================================================
            async function callClaudeAPI(prompt) {
                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 2048,
                            messages: [{ role: "user", content: prompt }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // Handle response format
                    if (data.content && Array.isArray(data.content)) {
                        const textContent = data.content.find((item) => item.type === "text");
                        if (textContent && textContent.text) {
                            return textContent.text;
                        }
                    }
                    
                    throw new Error("Unexpected API response format");
                } catch (error) {
                    console.error("AI API error:", error);
                    throw error;
                }
            }

            function showAIOutput(text) {
                const container = document.getElementById("ai-output-container");
                const output = document.getElementById("ai-output");
                container.classList.remove("hidden");
                output.textContent = text;
            }

            function showAILoading() {
                const container = document.getElementById("ai-output-container");
                const output = document.getElementById("ai-output");
                container.classList.remove("hidden");
                output.innerHTML = '<div class="ai-loading">Thinking</div>';
            }

            document.getElementById("btn-ai-summarize").addEventListener("click", async () => {
                const notes = document.getElementById("note-content").value;
                if (!notes.trim()) {
                    alert("Please write some notes first!");
                    return;
                }

                try {
                    showAILoading();
                    const prompt = `Please provide a concise summary of these study notes:\n\n${notes}`;
                    const result = await callClaudeAPI(prompt);
                    showAIOutput(result);
                } catch (error) {
                    showAIOutput(`Error: ${error.message}. The AI assistant requires an active connection. Please try again.`);
                }
            });

            document.getElementById("btn-ai-quiz").addEventListener("click", async () => {
                const notes = document.getElementById("note-content").value;
                if (!notes.trim()) {
                    alert("Please write some notes first!");
                    return;
                }

                try {
                    showAILoading();
                    const prompt = `Based on these study notes, create 5 quiz questions with answers:\n\n${notes}`;
                    const result = await callClaudeAPI(prompt);
                    showAIOutput(result);
                } catch (error) {
                    showAIOutput(`Error: ${error.message}. The AI assistant requires an active connection. Please try again.`);
                }
            });

            document.getElementById("btn-ai-explain").addEventListener("click", async () => {
                const notes = document.getElementById("note-content").value;
                if (!notes.trim()) {
                    alert("Please write some notes first!");
                    return;
                }

                try {
                    showAILoading();
                    const prompt = `Please explain the key concepts in these notes in simple terms:\n\n${notes}`;
                    const result = await callClaudeAPI(prompt);
                    showAIOutput(result);
                } catch (error) {
                    showAIOutput(`Error: ${error.message}. The AI assistant requires an active connection. Please try again.`);
                }
            });

            document.getElementById("btn-ai-studyguide").addEventListener("click", async () => {
                const notes = document.getElementById("note-content").value;
                if (!notes.trim()) {
                    alert("Please write some notes first!");
                    return;
                }

                try {
                    showAILoading();
                    const prompt = `Create a comprehensive study guide based on these notes, including key points, important terms, and concepts to review:\n\n${notes}`;
                    const result = await callClaudeAPI(prompt);
                    showAIOutput(result);
                } catch (error) {
                    showAIOutput(`Error: ${error.message}. The AI assistant requires an active connection. Please try again.`);
                }
            });

            console.log("Notey lessons page loaded with fixed formatting and AI!");
        </script>
    </body>
</html>
